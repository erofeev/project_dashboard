# Интеграция с ЕРМ системой

## Обзор

Данный модуль обеспечивает интеграцию PWA приложения с ЕРМ (Enterprise Resource Management) системой для автоматической выгрузки данных о пользователях, проектах, временных записях и активностях.

## Возможности

- **Автоматическая выгрузка данных** из ЕРМ системы
- **Динамическая конфигурация** - URL и API ключ настраиваются через UI и сохраняются в БД
- **Проверка подключения** - тестирование настроек перед обновлением данных
- **Выбор периода** для обновления данных
- **Прогресс-бар** с отображением текущего шага
- **Детальный лог** выполнения операций
- **Гибкая настройка** типов данных для обновления
- **Обработка ошибок** и повторные попытки
- **Персональные настройки** - каждый администратор может иметь свои настройки ERM

## Настройка

### 1. Конфигурация ЕРМ системы

Настройки подключения к ERM системе хранятся в базе данных PouchDB и привязаны к конкретному пользователю-администратору. Для настройки:

1. Войдите в систему как администратор
2. Перейдите в раздел "Администрирование" → "Обновление данных из ЕРМ"
3. Введите URL вашей ERM системы и API ключ
4. Нажмите "Проверить подключение" для тестирования
5. Нажмите "Обновить данные" для начала синхронизации

Настройки автоматически сохраняются в базе данных и будут использоваться при следующих запусках.

### 2. Проверка доступности ЕРМ

Убедитесь, что:
- ЕРМ система доступна по указанному URL
- API ключ действителен и имеет необходимые права
- CORS настройки позволяют доступ с вашего домена

### 3. Настройка прав доступа

Для доступа к разделу "Администрирование" пользователь должен иметь:
- Роль `admin` или флаг `isAdmin: true`
- Валидный токен авторизации

## Использование

### Доступ к админ-панели

1. Войдите в систему как администратор
2. В левом меню появится пункт "Администрирование"
3. Перейдите в раздел "Обновление данных из ЕРМ"

### Обновление данных

1. **Настройте подключение** - введите URL и API ключ вашей ERM системы
2. **Проверьте подключение** - нажмите "Проверить подключение" для тестирования
3. **Выберите период** - по умолчанию с 1-го числа текущего месяца по сегодня
4. **Отметьте типы данных** для обновления:
   - ✅ Пользователи и их настройки
   - ✅ Проекты и их параметры
   - ✅ Временные записи
   - ✅ Активности и категории работ
5. **Нажмите "Обновить данные из ЕРМ"**
6. **Следите за прогрессом** в реальном времени
7. **Просматривайте лог** выполнения операций

## Архитектура

### Компоненты

- `AdminComponent` - основная админ-панель
- `ERMDataUpdateComponent` - интерфейс обновления данных
- `UserManagementComponent` - управление пользователями (в разработке)
- `SystemSettingsComponent` - системные настройки (в разработке)

### Сервисы

- `ERMService` - интеграция с ЕРМ API
  - `updateUsers()` - обновление данных пользователей
  - `updateProjects()` - обновление данных проектов
  - `updateTimeEntries()` - обновление временных записей
  - `updateActivities()` - обновление активностей
  - `checkERMConnection()` - проверка подключения к ERM
  - `getERMSettings()` - получение настроек ERM
  - `saveERMSettings()` - сохранение настроек ERM
- `ProgressService` - отслеживание прогресса операций
- `DatabaseService` - работа с локальной PouchDB
  - `saveERMSettings()` - сохранение настроек ERM в БД
  - `getERMSettings()` - получение настроек ERM из БД

### Guards

- `AdminGuard` - проверка прав администратора
- `AuthGuard` - проверка авторизации

## API ЕРМ

### Endpoints

- `GET /users.json` - список пользователей
- `GET /projects.json` - список проектов
- `GET /easy_time_entries.json` - временные записи
- `GET /enumerations/time_entry_activities.json` - активности

### Параметры запросов

- `limit` - количество записей (по умолчанию 100)
- `from` - начальная дата (YYYY-MM-DD)
- `to` - конечная дата (YYYY-MM-DD)
- `status` - статус записей

### Заголовки

```
X-Redmine-API-Key: your-api-key
Content-Type: application/json
```

## Структура данных

### Настройки ERM (ERMSettings)

```typescript
interface ERMSettings {
  id?: string;
  userId: string;
  baseUrl: string;
  apiKey: string;
  createdAt?: string;
  updatedAt?: string;
}
```

### Пользователи (ERMUser)

```typescript
interface ERMUser {
  id: string;
  name: string;
  email: string;
  role: string;
  direction?: string;
  isAdmin?: boolean;
  salary?: number;
  hourlyRate?: number;
  workingDaysPerMonth?: number;
}
```

### Проекты (ERMProject)

```typescript
interface ERMProject {
  id: string;
  name: string;
  description?: string;
  direction: string;
  status: string;
  plannedCost?: number;
  plannedHours?: number;
  startDate?: string;
  endDate?: string;
  managerId?: string;
}
```

### Временные записи (ERMTimeEntry)

```typescript
interface ERMTimeEntry {
  id: string;
  projectId: string;
  userId: string;
  date: string;
  hours: number;
  activity: string;
  comments?: string;
}
```

### Активности (ERMActivity)

```typescript
interface ERMActivity {
  id: string;
  name: string;
  isDefault?: boolean;
  position?: number;
}
```

## Обработка ошибок

### Типы ошибок

- **Сетевые ошибки** - недоступность ЕРМ системы
- **Ошибки авторизации** - неверный API ключ
- **Ошибки данных** - некорректный формат ответа
- **Ошибки базы данных** - проблемы с PouchDB

### Повторные попытки

Система автоматически:
- Логирует все ошибки
- Отображает понятные сообщения пользователю
- Предлагает повторить операцию

## Мониторинг

### Логи

Все операции логируются с временными метками:
- `[12:34:56] Начинаем обновление данных из ЕРМ...`
- `[12:34:57] Загружено 25 пользователей`
- `[12:34:58] Обновление данных завершено успешно!`

### Прогресс

Отображается в реальном времени:
- Текущий шаг операции
- Процент выполнения
- Визуальный прогресс-бар

## Безопасность

### Права доступа

- Только администраторы могут обновлять данные
- Проверка токена авторизации
- Валидация входных данных

### Защита данных

- API ключи не сохраняются в localStorage
- Все запросы идут через HTTPS
- Логи не содержат чувствительной информации

## Базы данных

### PouchDB коллекции

Система использует следующие локальные базы данных:

- `users` - пользователи системы
- `projects` - проекты и их параметры
- `time_entries` - временные записи
- `activities` - активности и категории работ
- `erm_settings` - настройки подключения к ERM (по пользователям)
- `invoices` - счета (в разработке)
- `payments` - платежи (в разработке)

### Индексы

Для оптимизации поиска создаются индексы:
- `users`: по `email`, `role`, `direction`
- `projects`: по `direction`, `status`, `managerId`
- `time_entries`: по `projectId`, `userId`, `date`
- `activities`: по `name`, `isDefault`
- `erm_settings`: по `userId`

## Разработка

### Добавление новых типов данных

1. Создайте интерфейс в `ERMService`
2. Добавьте метод маппинга
3. Создайте метод обновления
4. Добавьте в UI компонент

### Расширение функциональности

- Добавление новых полей
- Поддержка дополнительных форматов
- Интеграция с другими системами

## Поддержка

### Логирование

Включите подробное логирование в консоли браузера для отладки.

### Мониторинг

Следите за:
- Временем выполнения операций
- Количеством обработанных записей
- Частотой ошибок

### Обновления

Регулярно проверяйте:
- Совместимость с новой версией ЕРМ
- Обновления API endpoints
- Изменения в структуре данных

## Заключение

Интеграция с ЕРМ системой обеспечивает автоматическое обновление данных в PWA приложении, что позволяет пользователям работать с актуальной информацией без ручного ввода. Система спроектирована с учетом масштабируемости и безопасности.
