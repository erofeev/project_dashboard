<!-- PROJECT ANALYTICS V2 - –ù–ê–°–¢–†–û–ô–ö–ò (–£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø) -->

<div class="settings-container glass-card">
  
  <!-- –ó–ê–ì–û–õ–û–í–û–ö -->
  <div class="settings-header">
    <h2 class="section-title">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</h2>
    <p class="settings-subtitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ERM –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∞–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
  </div>

  <!-- ERM –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï (–∞–Ω–∞–ª–æ–≥ Config –ª–∏—Å—Ç–∞ B2-B6) -->
  <section class="config-section">
    <h3>ERM API –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h3>
    
    <form [formGroup]="ermConfigForm" (ngSubmit)="saveERMConfig()">
      
      <div class="config-grid">
        
        <!-- Base URL -->
        <div class="field-group">
          <label for="baseUrl" class="field-label">Base URL *</label>
          <input 
            id="baseUrl"
            type="url" 
            formControlName="baseUrl"
            placeholder="http://localhost:3000/api"
            class="field-input"
          />
          <small class="field-hint">URL –≤–∞—à–µ–≥–æ ERM —Å–µ—Ä–≤–µ—Ä–∞ (–∞–Ω–∞–ª–æ–≥ B2 –≤ Excel)</small>
        </div>

        <!-- API Key -->
        <div class="field-group">
          <label for="apiKey" class="field-label">API Key *</label>
          <input 
            id="apiKey"
            type="password" 
            formControlName="apiKey"
            placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á"
            class="field-input"
          />
          <small class="field-hint">–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –∫ ERM API (–∞–Ω–∞–ª–æ–≥ B3 –≤ Excel)</small>
        </div>

        <!-- –ü–µ—Ä–∏–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="field-row">
          <div class="field-group">
            <label for="startDate" class="field-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ *</label>
            <input 
              id="startDate"
              type="date"
              formControlName="startDate"
              class="field-input"
            />
            <small class="field-hint">–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ (B4)</small>
          </div>

          <div class="field-group">
            <label for="endDate" class="field-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è *</label>
            <input 
              id="endDate"
              type="date"
              formControlName="endDate"
              class="field-input"
            />
            <small class="field-hint">–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞ (B5)</small>
          </div>
        </div>

        <!-- Project ID -->
        <div class="field-group">
          <label for="projectId" class="field-label">ID –ø—Ä–æ–µ–∫—Ç–∞</label>
          <input 
            id="projectId"
            type="text" 
            formControlName="projectId"
            placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤"
            class="field-input"
          />
          <small class="field-hint">–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–µ–∫—Ç—É (B6 –≤ Excel)</small>
        </div>

        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
        <div class="field-group">
          <label for="userFilter" class="field-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</label>
          <textarea 
            id="userFilter"
            formControlName="userFilter"
            placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò., –ü–µ—Ç—Ä–æ–≤ –ü.–ü."
            rows="3"
            class="field-input"
          ></textarea>
          <small class="field-hint">–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–∞–Ω–∞–ª–æ–≥ A9+ –≤ Excel)</small>
        </div>

      </div>

      <!-- –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
      <div class="action-buttons">
        <button 
          type="submit"
          class="btn btn-success"
          [disabled]="isLoading()"
        >
          {{ isLoading() ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é' }}
        </button>
        
        <button 
          type="button"
          class="btn btn-info"
          (click)="testERMConnection()"
          [disabled]="isTestingConnection() || !ermConfigForm.valid"
        >
          {{ isTestingConnection() ? '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...' : '–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' }}
        </button>

        <button 
          type="button"
          class="btn btn-primary"
          (click)="syncServiceData()"
          [disabled]="isSyncing() || connectionStatus() !== 'success'"
        >
          {{ isSyncing() ? '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏' }}
        </button>

        <button 
          type="button"
          class="btn btn-success"
          (click)="syncERMData()"
          [disabled]="isSyncing() || connectionStatus() !== 'success'"
        >
          {{ isSyncing() ? '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...' : '–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è' }}
        </button>
      </div>

    </form>

    <!-- –ù–û–í–´–ï –°–¢–†–ê–¢–ï–ì–ò–ò –ó–ê–ì–†–£–ó–ö–ò -->
    <section class="strategy-section glass-card">
      <h4>üéØ –£–º–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ (–∏–∑ Excel –ª–æ–≥–∏–∫–∏)</h4>
      
      <div class="strategy-buttons">
        <button 
          type="button"
          class="btn btn-info"
          (click)="quickLoadMasterData()"
          [disabled]="loadingStrategy() || connectionStatus() !== 'success'"
        >
          {{ loadingStrategy() === 'quick' ? 'üöÄ –ó–∞–≥—Ä—É–∑–∫–∞...' : 'üöÄ –ë—ã—Å—Ç—Ä–æ: –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏' }}
        </button>

        <button 
          type="button"
          class="btn btn-primary"
          (click)="loadByProjects()"
          [disabled]="loadingStrategy() || connectionStatus() !== 'success'"
        >
          {{ loadingStrategy() === 'projects' ? 'üìÅ –ó–∞–≥—Ä—É–∑–∫–∞...' : 'üìÅ –ü–æ –ø—Ä–æ–µ–∫—Ç–∞–º: –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' }}
        </button>
      </div>
      
      <p class="strategy-help">üí° <strong>–ë—ã—Å—Ç—Ä–æ</strong> - –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø—Ä–æ–µ–∫—Ç–æ–≤. <strong>–ü–æ –ø—Ä–æ–µ–∫—Ç–∞–º</strong> - –≤–∞—à–∞ –∏–¥–µ—è: –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã ‚Üí –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–∂–¥–æ–º—É.</p>
    </section>

    <!-- –í–´–ë–û–† –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô -->
    @if (discoveredUsers().length > 0) {
      <section class="users-selection glass-card">
        <h4>üë• –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</h4>
        
        <div class="users-controls">
          <button 
            type="button" 
            class="btn btn-sm btn-outline-primary" 
            (click)="selectAllUsers()"
          >–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</button>
          
          <button 
            type="button" 
            class="btn btn-sm btn-outline-secondary" 
            (click)="clearUserSelection()"
          >–û—á–∏—Å—Ç–∏—Ç—å</button>
          
          <span class="selection-info">
            –í—ã–±—Ä–∞–Ω–æ: {{ selectedUsers().length }} –∏–∑ {{ discoveredUsers().length }}
          </span>
        </div>
        
        <div class="users-grid">
          @for (user of discoveredUsers(); track user.id) {
            <label class="user-checkbox">
              <input 
                type="checkbox" 
                [checked]="selectedUsers().includes(user.id)"
                (change)="toggleUserSelection(user.id)"
              >
              <span class="user-name">{{ user.name }}</span>
              <small class="user-id">ID: {{ user.id }}</small>
            </label>
          }
        </div>
        
        <div class="save-selected">
          <button 
            type="button"
            class="btn btn-success"
            (click)="saveSelectedUsersData()"
            [disabled]="!selectedUsers().length || loadingStrategy()"
          >
            {{ loadingStrategy() === 'users' ? 'üéØ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : 'üéØ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö' }}
          </button>
        </div>
      </section>
    }

    <!-- –°–¢–ê–¢–£–° ERM –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò -->
    @if (connectionStatus() !== 'unknown' || syncStatus() || syncStats()) {
      <div class="status-section glass-card">
        <h4>–°—Ç–∞—Ç—É—Å ERM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</h4>
        
        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        @if (connectionStatus() !== 'unknown') {
          <div class="status-item">
            <span class="status-label">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:</span>
            <span [class]="connectionStatus() === 'success' ? 'status-success' : 'status-error'">
              {{ connectionStatus() === 'success' ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–æ' : '‚ùå –û—à–∏–±–∫–∞' }}
            </span>
          </div>
        }

        <!-- –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
        @if (syncStatus()) {
          <div class="status-item">
            <span class="status-label">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</span>
            <span>{{ syncStatus() }}</span>
          </div>
        }

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö -->
        @if (syncStats(); as stats) {
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-number">{{ stats.users }}</div>
              <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">{{ stats.projects }}</div>
              <div class="stat-label">–ü—Ä–æ–µ–∫—Ç–æ–≤</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">{{ stats.activities }}</div>
              <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">{{ stats.timeEntries }}</div>
              <div class="stat-label">–ó–∞–ø–∏—Å–µ–π –≤—Ä–µ–º–µ–Ω–∏</div>
            </div>
          </div>
          
          @if (stats.lastSync) {
            <div class="sync-time">
              –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: {{ stats.lastSync | date:'dd.MM.yyyy HH:mm:ss' }}
            </div>
          }
        }
      </div>
    }

  </section>

  <!-- –°–¢–ê–í–ö–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô (–∞–Ω–∞–ª–æ–≥ Rates –ª–∏—Å—Ç–∞) -->
  <section class="rates-section">
    <h3>–°—Ç–∞–≤–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3>
    
    <!-- –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ù–û–í–û–ô –°–¢–ê–í–ö–ò -->
    <div class="rates-card">
      <h4>–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–≤–∫—É</h4>
      <form [formGroup]="ratesForm" (ngSubmit)="addUserRate()">
        
        <div class="rates-grid">
          
          <div class="field-group">
            <label for="userName" class="field-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *</label>
            <input 
              id="userName"
              type="text" 
              formControlName="userName"
              placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
              class="field-input"
            />
          </div>

          <div class="field-group">
            <label for="dateFrom" class="field-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è *</label>
            <input 
              id="dateFrom"
              type="date"
              formControlName="dateFrom"
              class="field-input"
            />
          </div>

          <div class="field-row">
            <div class="field-group">
              <label for="grossPerMonth" class="field-label">–û–∫–ª–∞–¥ –≤ –º–µ—Å—è—Ü (—Ä—É–±)</label>
              <input 
                id="grossPerMonth"
                type="number" 
                formControlName="grossPerMonth"
                placeholder="0"
                min="0"
                class="field-input"
              />
              <small class="field-hint">–î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –æ–∫–ª–∞–¥–µ</small>
            </div>

            <div class="field-group">
              <label for="hourlyRate" class="field-label">–ü–æ—á–∞—Å–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ (—Ä—É–±)</label>
              <input 
                id="hourlyRate"
                type="number"
                formControlName="hourlyRate"
                placeholder="0"
                min="0"
                class="field-input"
              />
              <small class="field-hint">–î–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –ø–æ—á–∞—Å–æ–≤–æ–π –æ–ø–ª–∞—Ç–µ</small>
            </div>
          </div>

        </div>

        <div class="action-buttons">
          <button 
            type="submit"
            class="btn btn-success"
            [disabled]="!ratesForm.valid"
          >
            –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–≤–∫—É
          </button>
        </div>

      </form>
    </div>

    <!-- –°–ü–ò–°–û–ö –¢–ï–ö–£–©–ò–• –°–¢–ê–í–û–ö -->
    <div class="rates-list-card">
      <h4>–¢–µ–∫—É—â–∏–µ —Å—Ç–∞–≤–∫–∏</h4>
      
      @if (userRates().length === 0) {
        <div class="empty-state">
          <p>–°—Ç–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã.</p>
          <p>–î–æ–±–∞–≤—å—Ç–µ —Å—Ç–∞–≤–∫–∏ –≤—ã—à–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>
        </div>
      } @else {
        <div class="rates-table">
          @for (rate of userRates(); track $index) {
            <div class="rate-row">
              <div class="rate-info">
                <strong>{{ rate.userName }}</strong>
                <span class="rate-date">—Å {{ rate.startDate | date:'dd.MM.yyyy' }}</span>
              </div>
              <div class="rate-values">
                @if (rate.grossPerMonth && rate.grossPerMonth > 0) {
                  <span class="rate-salary">{{ rate.grossPerMonth | currency:'RUB':'symbol':'1.0-0' }}/–º–µ—Å</span>
                }
                @if (rate.hourlyRate && rate.hourlyRate > 0) {
                  <span class="rate-hourly">{{ rate.hourlyRate | currency:'RUB':'symbol':'1.0-0' }}/—á–∞—Å</span>
                }
              </div>
              <div class="rate-actions">
                <button 
                  class="btn btn-danger btn-sm"
                  (click)="removeUserRate($index)"
                  title="–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞–≤–∫—É"
                >
                  –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>

  </section>

  <!-- –≠–ö–°–ü–û–†–¢/–ò–ú–ü–û–†–¢ -->
  <section class="import-export-section">
    <div class="export-card">
      <h4>–≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h4>
      <p>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</p>
      <button 
        class="btn btn-info"
        (click)="exportConfiguration()"
      >
        –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON
      </button>
    </div>

    <div class="import-card">
      <h4>–ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h4>
      <p>–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞</p>
      <input 
        type="file" 
        accept=".json"
        (change)="onImportFile($event)"
        class="file-input"
      />
    </div>
  </section>

</div>